#!/usr/bin/env bash
# Copyright (C) 2019 LinkedData.Center - All Rights Reserved
# Permission to copy and modify is granted under the MIT license


function USAGE {
	>&2 cat <<-EOT
		Smart Data as a Service (SDaaS) knowledge graph engine
		Copyright (C) 2018-2020 http://linkeddata.center/
			
		startup options:
		
		-d, --background
			execute the platform as a daemon
		
		--readonly
		   disallow mutations in graph database
		   
		--size micro|small|medium|large|xlarge|xxlarge|custom
	EOT
	exit 1
}


### Parse command line options
__parsed=$(getopt -options="" --longoptions=foreground,readonly --name "$0" -- "$@") || USAGE
eval set -- "$__parsed"
unset __parsed 

FOREGROUND=1
READONLY=0
while true; do
	case "$1" in
	    --background)
	    	FOREGROUND=0
            shift
	    	;;
		--readonly)
	    	READONLY=1
            shift
	    	;;
	    --size)
			SIZE="${2-micro}"
	    	shift 2
        --)
            shift
            break
        ;;
	    *)
	        USAGE
	    ;;
	esac
	shift
done

case "${SIZE}" in
    micro)
    	JAVA_OPTS="-server -Xmx256m -Djava.awt.headless=true-XX:MaxDirectMemorySize=100m -XX:+UseG1GC"
    	;;
    small)
    	JAVA_OPTS="-server -Xmx1500m -Djava.awt.headless=true -XX:MaxDirectMemorySize=1000m -XX:+UseG1GC"
    	;;
    medium)
    	JAVA_OPTS="-server -Xmx3500m -Djava.awt.headless=true -XX:MaxDirectMemorySize=1500m -XX:+UseG1GC"
    	;;
	large)
    	JAVA_OPTS="-server -Xmx7g -Djava.awt.headless=true -XX:MaxDirectMemorySize=3000m -XX:+UseG1GC"
    	;;
	xlarge)
    	JAVA_OPTS="-server -Xmx15g -Djava.awt.headless=true XX:MaxDirectMemorySize=5000m -XX:+UseG1GC"
    	;;
	xxlarge)
    	JAVA_OPTS="-server -Xmx30g -Djava.awt.headless=true XX:MaxDirectMemorySize=6000m -XX:+UseG1GC"
    	;;
    # else do not changes  JAVA_OPTS
esac




if [  $READONLY -eq 1 ]; then 
	cp ${JETTY_BASE}/readonly-web.xml ${JETTY_BASE}/webapps/sdaas/WEB-INF/web.xml
else
	cp ${JETTY_BASE}/writable-web.xml ${JETTY_BASE}/webapps/sdaas/WEB-INF/web.xml
fi

STARTUP_CMD="java -jar /usr/local/jetty/start.jar STOP.PORT=28282 STOP.KEY=secret"

echo -n "SDaaS knowledge graph engine starting using $SIZE memory footprint."

if [ $FOREGROUND -eq 1 ]; then
	echo ". Press ctrl-c to stop."
	cd ${JETTY_BASE} &&  $STARTUP_CMD
else
	echo " as daemon."
	cd ${JETTY_BASE} &&  $STARTUP_CMD &
fi